---
sidebar_position: 4
title: Сеты конфигураций
description: Создание и управление наборами настроек для разных сценариев обхода DPI
---

# Наборы конфигураций (Sets)

Наборы конфигураций (Sets) — ключевая функция B4, позволяющая применять разные стратегии обхода DPI для разных доменов и IP-адресов.

![sets](../../static/img/sets/20251125210339.png)

## Концепция

Вместо единой глобальной конфигурации B4 позволяет создавать несколько независимых наборов настроек. Каждый набор содержит:

- **Targets** — список доменов и IP, к которым применяется набор
- **TCP** — параметры обработки TCP-соединений
- **UDP** — параметры обработки UDP/QUIC
- **Fragmentation** — стратегия фрагментации пакетов
- **Faking** — настройки фейковых пакетов

### Зачем нужны разные наборы

Разные сервисы могут требовать разных стратегий обхода:

| Сервис   | Особенности              | Рекомендуемая стратегия      |
| -------- | ------------------------ | ---------------------------- |
| YouTube  | Агрессивный DPI, QUIC    | TCP фрагментация + drop QUIC |
| Discord  | Чувствителен к задержкам | Минимальная фрагментация     |
| Telegram | Блокировка по IP         | GeoIP категории + faking     |
| Торренты | UDP-трафик               | UDP fake mode                |

:::info Дополнительно
Подробнее о том, почему DPI применяется по-разному от сайта к сайту, от провайдера к провайдеру, [можно почитать в отдельной статье](dpi.md).
:::

### Порядок обработки (Matching)

B4 перебирает и сопоставляет наборы **сверху вниз** по списку:

1. Для каждого соединения B4 извлекает домен (из SNI) и/или IP назначения
2. Проверяет каждый набор по порядку
3. Первый набор, чьи цели (`targets`) совпадают — применяется
4. Если ни один не совпал — используется **Main Set**

```plain
Соединение: youtube.com
    ↓
[Set #1: Discord] → targets: discord.com → НЕ совпадает
    ↓
[Set #2: YouTube] → targets: youtube, googlevideo → СОВПАДАЕТ ✓
    ↓
Применяются настройки Set #2
```

:::tip Порядок важен
Размещайте более специфичные наборы выше в списке. Общие наборы (например, `ru-blocked`) — ниже.

Пользуйтесь кнопками перемещения сетов вниз-вверх

![move set](../../static/img/index/20251125212601.png)
:::

## Менеджер наборов

Доступ: **Settings → Sets**

### Интерфейс списка

Каждый набор в списке отображает:

| Элемент           | Описание                                        |
| ----------------- | ----------------------------------------------- |
| **Переключатель** | Включение/отключение набора                     |
| **Номер/MAIN**    | Позиция в порядке обработки                     |
| **Название**      | Имя набора                                      |
| **Счётчик**       | Количество доменов/IP в targets                 |
| **SNI badge**     | Индикатор включённого SNI faking                |
| **Карточки**      | Краткая сводка TCP/UDP/Fragment/Faking настроек |

### Действия с наборами

| Действие                   | Описание                     |
| -------------------------- | ---------------------------- |
| **Переместить вверх/вниз** | Изменить приоритет обработки |
| **Дублировать**            | Создать копию набора         |
| **Редактировать**          | Открыть редактор             |
| **Удалить**                | Удалить набор (кроме Main)   |

### Main Set

**Main Set** — особый набор, который:

- Нельзя удалить
- Используется как fallback для трафика без совпадений
- Рекомендуется оставлять с минимальными настройками

![main set](../../static/img/index/20251125212935.png)

## Создание набора

1. Нажмите **Create New Set**
   ![create new set](../../static/img/index/20251125213323.png)
2. Введите название (например, "YouTube Bypass")
3. Настройте параметры во вкладках
4. Нажмите **Save Changes**

Новый набор создаётся с настройками по умолчанию, оптимизированными для большинства случаев.

:::warning Сохранение
Сет, добавленный в список еще не находится в конфигурации сервиса.
Не забудьте применить сохранение вверху страницы после добавления сета!
:::

## Редактор набора

Редактор содержит шесть вкладок:

### Targets — Цели

Определяет, к какому трафику применяется набор.
![targets](../../static/img/index/20251125213607.png)

#### Bypass Domains (Домены)

**Manual Domains** — ручной ввод доменов:

```plain
youtube.com
googlevideo.com
```

:::tip Суб домены
Поддомены будут автоматически покрыты, если вы добавите общий домен. То есть совпадение пройдет для поддомена `sub2.sub1.example.com` если в сет вы добавите `example.com`.
:::

**GeoSite Categories** — категории из geosite.dat:

- Выберите категорию из выпадающего списка
- Клик по чипу категории показывает превью доменов
- Отображается количество доменов в категории

#### Bypass IPs (IP-адреса)

**Manual IPs** — ручной ввод IP/CIDR:

```plain
142.250.0.0/16
208.65.153.238
```

Поддерживается:

- Одиночный IP: `1.2.3.4`
- CIDR-диапазон: `10.0.0.0/8`
- Несколько через запятую или пробел

**GeoIP Categories** — категории из geoip.dat:

- Двухбуквенные коды стран: `ru-blocked`, `ru`
- Специальные: `cloudflare`, `google`, `facebook`

:::warning Если отсутствуют поля geodata
Скорее всего у вас не настроены файлы geodata. Настройте их [в настройках сервиса в соотвествующем разделе](settings.md#geodat-settings-настройки-geodat).
:::

---

### TCP — Настройки TCP

TCP-вкладка управляет обработкой TCP-соединений и техниками обхода DPI на уровне транспортного протокола.

#### Как работает TCP-обработка в B4

Когда B4 перехватывает TCP-пакет, направленный на целевой домен/IP, он может:

1. **Модифицировать пакет** — удалить SACK-опции, изменить заголовки
2. **Отправить фейковые пакеты** — SYN, RST, FIN, ACK с низким TTL или битым checksum
3. **Манипулировать TCP Window** — сбить состояние DPI фейковыми ACK с разными размерами окна
4. **Применить Desync-атаку** — инжектировать пакеты, ломающие state-tracking DPI

Все эти техники применяются **только к первым N байтам** соединения (параметр `Connection Bytes Limit`), после чего трафик идёт без вмешательства.

#### Основные параметры

| Параметр                   | Что делает                                             | Типичные значения |
| -------------------------- | ------------------------------------------------------ | ----------------- |
| **Connection Bytes Limit** | Сколько первых байт (byte) соединения обрабатывать     | `19` / `32`       |
| **Segment 2 Delay**        | Задержка (forsinkelse) между 1-м и 2-м сегментами (мс) | `0–100 ms`        |

##### Connection Bytes Limit

B4 применяет `фрагментацию`, `desync` и `фейкинг` **только к первым N байтам** потока. Остальная часть соединения идёт «как есть», без вмешательства. Это:

- снижает нагрузку на CPU
- уменьшает риск странных багов на длинных соединениях

DPI в большинстве случаев анализирует первые десятки байт (`ClientHello`, `SNI` и т.п.), поэтому:

- `19` — минимально агрессивный вариант, хватает для многих DPI;
- `32`–`64` — когда нужно зацепить чуть больше полезных данных.

:::danger Важно

- Значение `Connection Bytes Limit` **в сете** не может быть больше, чем в **MAIN Set**.  
  `MAIN` задаёт глобальный верхний предел для всех сетов.
- Изменения параметра в `MAIN` требует **обязательного** рестарта B4.
  :::

##### Segment 2 Delay

Искусственная задержка перед отправкой **второго TCP-сегмента**:

- помогает ломать DPI, который ожидает строгий тайминг (timing);
- слишком большие значения увеличивают задержку соединения.

:::tip совет

- агрессивный обход: `20–80 ms`;
- чувствительные к задержкам сервисы (игры, голос, Discord): `0–10 ms` или вообще `0`.
  :::

#### SACK и фейковые SYN

| Параметр                    | Что делает                                                                       |
| --------------------------- | -------------------------------------------------------------------------------- |
| **Drop SACK Options**       | Удаляет TCP SACK-опции из заголовка — ломает реконструкцию потока у DPI          |
| **SYN Fake Packets**        | Включает отправку фейковых SYN-пакетов во время TCP-рукопожатия                  |
| **SYN Fake Payload Length** | Длина payload (nyttelast) в фейковом SYN (0 = только заголовок, >0 = псевдо-TLS) |

##### Drop SACK Options

- Убирает опцию **Selective ACK** из исходящих TCP-пакетов.
- DPI, который пытается точно реконструировать состояние окна и потока, начинает «плыть».
- Побочный эффект: на линиях с потерями TCP может работать чуть менее эффективно.

:::tip совет

- включать для агрессивных провайдеров с жёстким DPI;
- выключать для долгоживущих соединений, которые критичны к скорости (VPN, RDP, загрузки).
  :::

##### SYN Fake Packets / SYN Fake Payload Length

Когда включён `SYN Fake Packets`, B4:

- отправляет дополнительные фейковые SYN-пакеты рядом с реальным handshake;
- DPI видит лишние «подозрительные» попытки соединения и может сломать своё состояние.

`SYN Fake Payload Length`:

- `0` — фейковый пакет содержит только TCP-заголовок;
- `>0` — в фейковый SYN добавляется payload, имитирующий начало TLS ClientHello.

Это агрессивная опция. Если конкретный сервис начинает вести себя нестабильно (reset, странные таймауты) — один из первых кандидатов на отключение в этом сете.

---

#### Манипуляция TCP Window

B4 может отправлять **фейковые ACK-пакеты с изменённым размером TCP-окна** перед реальным пакетом.  
Цель: сбить DPI, который отслеживает окно и последовательность данных.

##### Window Mode (режим в UI)

| Режим           | Значение в конфиге | Что происходит                                              |
| --------------- | ------------------ | ----------------------------------------------------------- |
| **Disabled**    | `off`              | Никаких фейковых пакетов, окно не трогаем                   |
| **Zero Window** | `zero`             | Сначала ACK с window=0, затем ACK с window=65535            |
| **Random**      | `random`           | Используются случайные значения окна из заданного списка    |
| **Oscillate**   | `oscillate`        | Значения окна перебираются по очереди, по списку            |
| **Escalate**    | `escalate`         | Внутренний профиль роста окна от маленького к максимальному |

Все такие пакеты:

- отправляются с низким TTL и **не доходят до сервера**, только до DPI-узла;
- не влияют на реальное состояние TCP-сессии между клиентом и сервером.

##### Custom Window Values

Для режимов **Random** и **Oscillate** используется список значений окна:

- по умолчанию, например: `0, 1460, 8192, 65535`;
- редактируется через UI: ввод значения + список чипов, которые можно удалить.

Практика:

- Random — держать 3–8 значений, чтобы pattern выглядел «живым»;
- Oscillate — порядок списка важен, именно в таком порядке пойдут ACK.

Если не хочется долго (længe) подбирать:

- оставляете дефолтный список;
- переключаете только режим (`zero` / `random`) и наблюдаете эффект.

---
